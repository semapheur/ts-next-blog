---
title: 'Financial Analysis'
subject: 'Mathematics'
showToc: true
references:
  - book_elliott_kopp_1998
  - book_cvitanic_zapatero_2004
  - paper_leung_li_2014
  - paper_leung_lu_2024
---

# Interest rate

Interest is the cost of borrowing money paid in fixed amounts on a fixed schedule over the lending period. Interest rate is the amount of interest due per period, as a proportion of the remaining amount of borrowed money, called the principal. 

Interest is classified as *simple* or *compound*. Simple interest is calculated only on the remaining principal, while compound interest also includes interest earned on previously accumulated interest.

Interest rate is usually stated on an annualized term either as a *nominal* or *effective* rate. Nominal interest rate (also called coupon rate) is the stated annual interest without accounting for compounding effects. Effective interest rate is the true interest rate accounting for compounding effects.

Consider a pure discount (zero-coupon) bond with price given by $P:[0,\infty)\to\R$. Suppose the bond is bought at time $t$ and matures at time $T$. The interest of the bond is the value $r\in\R$ that solves

$$
  P(t)(1 + r) = P(T) \iff r = \frac{P(T) - P(t)}{P(t)}
$$

If $f\in\R$ is the annualized compounding frequency, and $r$ is the annual nominal rate, the effective rate is given by  

$$
  1 + R = \left(1 + \frac{r}{f} \right)^f \iff R = \left(1 + \frac{r}{f} \right)^f - 1
$$

The *continuously compunded interest rate* is the rate paid at infinite frequency

$$
  1 + R = \lim_{n\to\infty} \left(1 + \frac{r}{f}\right)^f = e^r
$$

## Present value

Present value is the current value of expected income payments. Consider a time interval $[0,T]$ consisting of $n$ equally spaced periods, with interest rate $r$ per period. Suppose that we receive a payment $P_t$ at time $t\in[0,T]$. The compounded future value of the cash flow is

$$
  P(T) = \sum_{i=0}^m P_i (1 + r)^{m - i}
$$

The present value of the cash flows is

$$
  V(0) = \sum_{i=0}^m \frac{V_i}{(1 + r)^{m-i}} = \frac{V(T)}{(1 + r)^m}
$$

where $d = \frac{1}{1 + r}$ is called the *discount factor*.

Recall the summation formula for a geometric sequence

$$
  \sum_{i=1}^m \frac{1}{(1 + r)^m} = \frac{1}{r}\left(1 - \frac{1}{(1 + r)^m} \right)
$$

If the cash flow consists of equal payments $P$, the present value takes the form 

$$
  V(0) = \frac{P}{r}\left(1 - \frac{1}{(1 + r)^m} \right)
$$

Solving for $P$ yields

$$
  P = \frac{r(1 + r)^m V(0)}{(1 + r)^m - 1}
$$

## Bond yield

The *yield*, or *internal rate of return* (IRR) of a bond is the interest rate value for which the present value of the bond's payments (the coupons and the face value) equals the current bond price.

Let $V$ be the face value of a bond with $n$ coupon payments per year at regular intervals, each of size $C/n$. Suppose that there are $T$ years left until maturity, for a total of $T\cdot n = m$ periods until maturity. If $y(t)$ is the yield, the bond price is given by

$$
  P(t) = \frac{V}{(1 + y(t))^T} + \sum_{i=1}^m \frac{C/n}{(1 + y(t))^{i/n}}
$$

This shows that the price and yield of the bond are inversely related; higher yield implies lower price and vice versa, because paying less for a bond today means getting a higher return later.

# Bonds and term structure

## Market dynamics

Suppose $(\Omega,\mathcal{F},\mathbb{P})$ is a probability space, $(B_t)_{0\leq t \leq T}$ is a Brownian motion, and $(\mathcal{F}_t)$ is the (complete, right-continuous) filtration generated by $B$.

Consider the case of a bond $S^0$ and a single risky asset $S^1$. We suppose

$$
\begin{align*}
  S_t^0 =& \exp\left(\int_0^t r_u \d u \right) \\
  S_t^1 =& S_0^1 + \int_0^t \mu(u) S_u^1 \d u + \int_0^1 \sigma(u) S_u^1 \;\d B_u
\end{align*}
$$

where $r$, $\mu$ and $\sigma$ are adapted (random) processes. In particular, $r$ is a stochastic interest rate in general. Consider a self-financing strategy $(H^0, H^1)$. The corresponding wealth process is

$$
  X_t = H_t^0 S_t^0 + H_t^1 S_t^1
$$

and

$$
\begin{align*}
  \d X_t =& r H_t^0 S_t^0 \;\d t + H_t^1 \;\d S_t^1 \\
  =& r(X_t - H_t^1 S_t^1) \;\d t + H_t^1 \;\d S_t^1
\end{align*}
$$

With $\theta_t = \frac{\mu(t) - r_t}{\sigma(t)}$, the process $W^\theta$, where

$$
  \d W_t^\theta = \theta_t \;\d t + \d B_t
$$

is a Brownian motion under the measure $\mathbb{P}^\theta$. Consequently, under $\mathbb{P}^\t$ the discounted wealth process is $X_t/S_t^0$, and

$$
  \d\left(\frac{X_t}{S_t^0}\right) = H_t^1 \sigma(t) \frac{S_t^1}{S_t^0} \d W_t^\theta
$$

That is, for any self-financing strategy, the discounted wealth process $(X_t/S_t^0)$ is a martingale under the martingale measure $\mathbb{P}^\theta$. Consider a contingent claim $h \in \mathcal{L}^2 (\Omega, \mathcal{F}_T$. Then

$$
  M_t = \mathcal{E}^\theta \left(\frac{h}{S_t^0}|\mathcal{F}\right)
$$

is a martingale. Using the martingale representation theorem yields

$$
  M_t = M_0 + \int_0^t \phi_u \;\d W_u^\theta
$$

If we take

$$
  H_t^1 = \frac{S_t^0 \phi_t}{\sigma(t)S_t^1},\quad X_0 = M_0 = \mathbb{E}^\theta \left(\frac{h}{S_t^0} \right)
$$

and write

$$
  M_t = \frac{X_t}{S_t^0} = X_0 + \int_0^t H_u^1 \sigma(t) \frac{S_u^t}{S_u^0} \;\d W_t^\theta
$$

then, with

$$
  H_t^0 = \frac{X_t}{S_t^0} - H_t^1 \frac{S_t^1}{S_t^0}
$$

the pair $(H^0, H^1)$ is a self-financing strategy that hedges the claim $h$, i.e.

$$
  X_T = H_T^0 S_t^0 + H_T^1 S_T^1 = h
$$

The fair price for the claim at time $\mathbb{E}\left(\frac{h}{S_t^0}\right)$. The price at time $t\in[0,T]$ is $X_h (t) = X_t$, and this equals

$$
  S_t^0 \mathbb{E}^\theta \left(\frac{h}{S_t^0}|\mathcal{F}_t\right) = S_t^0 \mathbb{E}^\theta \left(\frac{X_t}{S_T^0}|\mathcal{F}_t \right)
$$

because $(X_t / S_t^0$ is a martingale under $\mathbb{P}^\theta$.

Suppose we have a market with several risky assets $S_t^0,\dots,S_t^N$ with dynamics

$$
\begin{align*}
  \d S_t^0 =& r_t S_t^0 \;\d t,\; S_0^0 = 1 \\
  \d S_t^i =& S_t^i \left(\mu_i (t) \;\d t + \sum_{j=1}^m \sigma_{ij}\;\d W_j (t) \right),\; S_0^i = s_i, i=1,\dots,n
\end{align*}
$$

Here $(\mathbb{W}_t) = (W_1 (t),\dots, W_m (t))$ is an $m$-dimensional Brownian motion on $(\Omega,\mathcal{F},\mathbb{P})$. The risk-neutral pricing formula holds as long as there is a unique risk-neutral measure $\mathbb{P}^\theta$. In such an exmple, the price at time $t\leq T$ of a claim $h\in\mathcal{L}^2 (\mathcal{F}_T)$ is

$$
  X_t = S_t^0 \mathbb{E}^\theta \left(h (S_T^0)^{-1}\middle|\mathcal{F}_t \right)
$$

From the pricing formula, the value at time $t\in[0,T]$ of a zero coupon bond maturing at time $T$ is

$$
\begin{align*}
  B(t, T) =& S_t^0 \mathbb{E}^\theta \left(\frac{1}{S_T^0} \right)
  =& \mathbb{E}^\theta \left(\exp\left(-\int_t^T r_u \;\d u \right)\middle|\mathcal{F}_t \right)
\end{align*}
$$

and

$$
  \d B(t,T) = r_t B(t, T) \;\d t
$$

## Term structure models

A term structure model describes the price $B(t,T)$ of a zero coupon bond maturing at time $T$ for $t\in[0,T]$. The yield 

$$
  R(t,T) = \frac{\ln[B(t,T)]}\frac{T-t}
$$

represents the average return of bonds after eliminating the distorting effects of maturity. We expect different yields at different maturitites, reflecting market beliefs about changes in interest rates. While greater uncertainty about interest rates in the distant future will tend to lead to increases in yield with maturity, high current rates (which may be expected to fall) can produce "inverted" yield curves, in which long bonds will have a lower yield than short ones. A satisfactory term structure model should be able to handle both situation.

Since $B(t,T)$ is a positive process, its dynamics can be expressed in a log normal form

$$
  \d B(t, T) = \mu(t, T) B(t, T) \;\d t + \sigma(t, T) B(t, T) \;\d W,\; t\in[0,T]
$$

Consequently

$$
  \d\left(\frac{B(t,T)}{S_t^0} \right) = (\mu(t, T) - r_t) \frac{B(t,T)}{S_t^0} \;\d t + \sigma(t, T)\frac{B(t,T)}{S_t^0}\;\d W_t
$$

showing that $(B(t,T)/S_t^0)$ is a martingale under $\mathbb{P}^\theta$ if and only if $\mu(t,T) = r_t$.

The statement that

$$
  B(t,T) = \mathbb{E}^\theta \left[\exp\left(-\int_t^T r_u \;\d u \right)\middle| \mathcal{F}_t \right]
$$

is sometimes called the *local expectations hypothesis.*

The assumption that holding a discount bond to maturity gives the same return as rolling over a series of single-period bonds is called the *return to maturity expectations hypothesis*. In continuous time, it would state that, under some probability measure $\mathbb{P}'$

$$
  \frac{1}{B(t,T)} = \mathbb{E}_{\mathbb{P}'} \left[\exp\left(\int_t^T r_u \;\d u \right)\middle| \mathcal{F}_t \right]
$$

The *yield to maturity expectations hypthesis* states that the yield from holding a bond equals the yield from rolling over a series of single-period bonds. In continuous time, this would imply

$$
  B(t, T) = \exp\left[-\mathbb{E}_{\mathbb{P}'} \left(\int_t^T r_u \;\d u \middle| \mathcal{F}_t \right)\right]
$$

for some probability measure $\mathbb{P}'$.

### Vasicek's model

Vasicek proposed a mean-reverting version of the Ornstein-Uhlenbeck process for the short term rate $r$. Specifically, under the risk-neutral measure $\mathbb{P}$, $r$ is given by

$$
  \d r = a(b - r_t) \;\d t + \sigma \;\d W_t
$$

for $r_0 > 0$, $a > 0$, $b > 0$, and $\sigma > 0$. Then

$$
  r_t = e^{-at} \left(r_0 + b(e^{at} - 1) + \sigma \int_0^t e^{au} \;\d W_u \right)
$$

Consequently, $r_t$ is a normal random variable with mean

$$
  \mathbb{E}(r_t) = e^{-at} (r_0 + b(e^{at} - 1))
$$

and variance

$$
  \operatorname{Var}(r_t) = \sigma^2 \left(\frac{1 - e^{-2at}}{2a} \right)
$$

Since a normal random variable can be negative with positive probability, so this model for $r$ is not realistic (unless the probability of being negative is small).

As $t\to\infty$, we see that $r_t$ converges in law to a Gaussian random variable with mean $b$ and variance $b^2 /2a$. The price of a zero coupon bond in the Vasicek model is therefore


$$
\begin{align*}
  B(t, T) =& \mathbb{E}\left[\exp\left(-\int_t^T r_u \;\d u\right)\middle|\mathcal{F}_t \right] \\
  =& e^{-b(T - t)} \mathbb{E}\left[\exp\left(-\int_t^T X_u \;\d u\right)\middle|\mathcal{F}_t \right]
\end{align*}
$$

where $X_u = r_u - b$. Now $X$ is the solution of the classical Ornstein-Uhlenbeck equation

$$
  \d X_t = -a X_t \;\d t + \sigma\;\d W_t
$$


with $X_0 = r_0 - b$. Write

$$
  Z(t, x) = \mathbb{E}\left[\exp\left(-\int_0^t X(u,x) \;\d u \right)\right]
$$

where $X(u,x)$ is the solution of $\eqref{equation-}$ with $X(0,x) = x$. Now

$$
  X(u,x) = e^{-au}\left(x + \int_0^u \sigma e^{as} \;\d W_s \right)
$$

so $X(u,x)$ is a Gaussian process with continuous sample paths. Consequently, $\left(\int_0^t X(u,x) \;\d u \right)$ is a Gaussian process. This can be established by considering moment-generating functions $\exp\left(u_1 X(t_1) +\cdots+ u_n X)t_n) \right)$.

If $Y$ is a Gaussian random variable with $\mathbb{E}(Y) = m$ and $\operatorname{Var}(Y) = \gamma^2$, we know that

$$
  \mathbb{E}(e^Y) = e^{-m + \gamma^2 /2}
$$

Now

$$
\begin{align*}
  \mathbb{E}[X(u,x)] =& xe^{-au} \\
  \mathbb{E}\left(\int_0^t X(u,x) \;\d u \right) =& \frac{x}{a}(1 - e^{-at})
\end{align*}
$$

and

$$
\begin{align*}
  \operatorname{Cov}[X(t,u), X(t,u)] =& \sigma^2 e^{-a(u + t)} \mathbb{E}\left(\int_0^t e^{as} \;\d W_s \int_0^u e^{as} \;\d W_s \right) \\
  =& \sigma^2 e^{-a(u + t)} \int_0^{u\lor t} e^{2as} \;\d s
  =& \frac{\sigma^2}{2a} e^{-a(u+t)} \left(e^{2a(u\lor t)} - 1 \right)
\end{align*}
$$

Thus,

$$
\begin{align*}
  \operatorname{Var}\left(\int_0^t X(u,x) \;\d u \right) =& \operatorname{Cov}\left(\int_0^t X(u,x) \;\d u, \int_0^t X(s, x) \;\d s \right) \\
  =& \int_0^t \int_0^t \operatorname{Cov}\left[X(u,x), X(s,x)\right] \;\d u \;\d s \\
  =& \int_0^t \int_0^t \frac{\sigma^2}{2a} e^{-a(u+t)} \left(e^{2a(u\lor t)} - 1 \right) \;\d \;\d s \\
  =& \frac{\sigma^2}{2a^3} (2at - 3 + 4e^{-at} - e^{-2at})
\end{align*}
$$

Consequently,

$$
\begin{align*}
  Z(t,x) =& \mathbb{E}\left(-\int_0^t X(u,x) \;\d u \right) \\
  =& \exp\left[-\frac{x}{a} (1 - e^{-at}) + \frac{1}{4}\frac{\sigma^2}{a^3} (2at - 3 + 4e^{-at} - e^{-2at} \right]
\end{align*}
$$

Using the homogeneity of the $X$ process,

$$
  B(t,T) = e^{-b(T - t)} Z(T - t, r_t - b)
$$

This can be written as

$$
  B(t, T) = \exp\left[-(T - t) R(T - t, r_t) \right]
$$

where $R(T - t, r_t)$ can be interpreted as the interest rate between times $t$ and $T$. With $R_\infty = b - \sigma^2 /2a^2$, we can write

$$
  R(t, t) = R_\infty - \frac{1}{at}\left((R_\infty - r)(1 - e^{-at}) - \frac{\sigma^2}{4a^2} (1 - e^{-at})^2 \right)
$$

Note that $R_\infty = \lim_{t\to\infty} R(t, r)$, so $R_\infty$ can be interpreted as the long term interest rate. However, $R_\infty$ does not depend on the instantaneous rate $r_t$, which is considered a weakness of the Vasicek model.

### The Hull-White model

The Hull-White one-factor model is a generalization of the Vasciek model. The one-factor model describes the short term rate with the stochastic differential equation

$$
\begin{equation*}
  \d r_t = (\alpha(t) - \beta(t) r_t)\;\d t + \sigma(t) \;\d W_t,\; r_0 > 0
\tag{\label{equation-33}}
\end{equation*}
$$

where $\alpha$, $\beta$, and $\sigma$ are deteministic functions of $t$.

Write $b(t) = \int_0^t \beta(u) \;\d u$, so $b$ is also non-random. Solving $\eqref{equation-33}$ by variation of constants yields

$$
  r_t = e^{-b(t)}\left(r_0 + \int_0^t e^{b(u)} \alpha(u) \;\d u + \int_0^t e^{b(u)} \sigma(u) \;\d W_u \right)
$$

Consequently, $r_t$ is a Gaussian Markov process with mean

$$
  \mathbb{E}(r_t) = m(t) = e^{-b(t)} \left(r_0 + \int_0^t e^{b(u)} \alpha(u) \;\d u \right)
$$

and convariance

$$
  \operatorname{Cov}(r_t, r_s) = e^{-b(s) - b(t)} \int_0^{s\lor t} e^{2b(u)} \sigma^2 (u) \;\d u
$$

The process $\int_0^T r_t \;\d t$ is normal, with mean

$$
  \mathbb{E}\left(\int_0^T r_t \;\d t \right) = \int_0^T e^{-b(t)}\left(r_0 + \int_0^t e^{b(u)} \alpha(u) \;\d u \right) \;\d t
$$

and variance

$$
  \operatorname{Var}\left(\int_0^T r_t \;\d t \right) = \int_0^T e^{2b(u)} \sigma^2 (u) \left(\int_u^T e^{-b(s)} \;\d s \right)^2 \;\d u
$$

The price of a zero coupon bond for this model is

$$
  B(0, T) = \mathbb{E}\left[\exp\left(-\int_0^T r_t \;\d t \right)\right]
$$

The quantity in the exponential is Gaussian, so that

$$
\begin{align*}
  B(0,T) =& \exp\left[-\mathbb{E} \left(\int_0^T r_t \;\d t \right) + \frac{1}{2} \operatorname{Var} \left(\int_0^T r_t \;\d t \right) \right] \\
  =& \exp\left[-r_0 \int_0^T e^{-b(t)} \;\d t - \int_0^T \int_0^t e^{-b(t) + b(u)} \alpha(u) \;\d u \;\d t \right.
  &+ \left. \frac{1}{2} \int_0^T e^{2b(u)} \sigma^2 (u) \left(\int_u^T e^{-b(s)} \;\d s \right)^2 \;\d u \right]
  =& \exp\left[-r_0 C(0,T) - A(0,T) \right]
\end{align*}
$$

where

$$
  C(0,T) = \int_0^T e^{-b(t)} \;\d t
$$

and

$$
\begin{align*}
  A(0,T) =& \int_0^T \int_0^t e^{-b(t) + b(u)} \;\d u \;\d t \\
  &- \frac{1}{2} \int_0^T e^{2b(u)} \sigma^2 (u) \left(\int_u^T e^{-b(s)} \;\d s \right)^2 \;\d u
\end{align*}
$$

Using Fubinis theorem, the first term in $A$ can be written as

$$
  \int_0^T \int_u^T e^{-b(t) + b(u)} \alpha(u) \;\d \;\d t = \int_0^T e^{b(u)} \alpha(u) \left(e^{-b(s)} \;\d s \right) \;\d u
$$

Thus

$$
  A(0,T) = \int_0^T \left(e^{b(u)} \alpha(u) \gamma(u) - \frac{1}{2} e^{2b(u)} \sigma^2 (u) \gamma^2 (u) \right) \;\d u
$$

where

$$
  \gamma(u) = \int_u^T e^{-b(s)} \;\d s
$$

The price at time $t$ of a zero coupon bond is

$$
\begin{align*}
  B(t, T) =& \mathbb{E}\left[\exp\left(-\int_t^T r_u \;\d u \right)\middle| \mathcal{F}_t \right] \\
  =& \mathbb{E}\left[\exp\left(-\int_t^T r_u \;\d u\right)\middle| r_t \right]
\end{align*}
$$

where the last step follows because $r$ is Markov. Write

$$
  C(t, T) = e^{b(t)} \int_t^T e^{-b(u)} \;\d u = e^{b(t)} \gamma(t)
$$

and

$$
  A(t, T) = \int_t^T \left(e^{b(u)} \alpha(u) \gamma(u) - \frac{1}{2} e^{2b(u)} \sigma^2 (u) \gamma^2 (u) \right) \;\d u
$$

It can be shown that

$$
\begin{equation*}
  B(t, T) = \exp\left[-r_t C(t,T) - A(t, T) \right]
\tag{\label{equation-34}}
\end{equation*}
$$

Since $\alpha$, $\beta$, and $\gamma$ are deterministic functions of time $t$, it follows that $C(t,T)$ and $A(t,T)$ are also functions only of $t$. From $\eqref{equation-34}$ we have

$$
\begin{equation*}
\begin{split}
  \d B(t, T) =& B(t, T) \left[-C(t, T) (\alpha(t) - \beta(t) r_t) \;\d t \right. \\
  &- \left. C(t,T) \sigma(t) \;\d W_t - \frac{1}{2} C^2 (t, T) \sigma^2 (t) \;\d t - r_t C_t (t, T) \;\d - A_t (t, T)\;\d t
\end{split}
\tag{\label{equation-35}}
\end{equation*}
$$

where $C_t = \partial C / \partial t$ and $A_t = \partial A / \partial t$. We are working under the risk-neutral meausre, so

$$
\begin{equation*}
  \d B(t, T) = r_t B(t, T) \;\d t + \Delta(t) \;\d W_t
\tag{\label{equation-36}}
\end{equation*}
$$

where $\Delta$ is some coefficient function. Comparing $\eqref{equation-35}$ and $\eqref{equation-36}$, we see that we must have

$$
  r_t = -C(t, t) (\alpha(t) - \beta(t) r_t ) - \frac{1}{2} C^2 (t, T) \sigma^2 (t) - r_t C_t (t, T) - A(t, T)
$$

Consequently,

$$
  \d B(t, T) = r_t B(t, T) \;\d t - B(t, T) \sigma(t) C(t, T) \;\d W_t
$$

The volatility of the zero coupon bond is $\sigma(t) C(t, T)$.

## The Cox-Ingersoll-Ross (CIR) model

Unlike the Vasicek and Hull-White models, which permit negative short term rates $r_t$, the Cox-Ingersoll-Ross (CIR) model ensures that $r_t$ remains non-negative for all $t$. To describe CIR process, recall the Ornstein-Uhlenbeck equation

$$
  \d X_t = -aX_t \d t + \sigma\d W_t
$$

with solution

$$
  X(t, x) = e^{-at}\left(x + \int_0^t \sigma e^{as} \;\d W_s \right)
$$

where $W$ is a standard Brownian motion on a probability space $(\Omega, \mathcal{F}, \mathbb{P})$. Suppose we have $n$ independent Brownian motions $W_1 ,\dots, W_n$ on $(\Omega, \mathcal{F}, \mathbb{P})$ and $n$ Ornstein-Uhlenbeck processes $X_1, \dots, X_n$ given by equations

$$
  \d X_i (t) = -\frac{1}{2} aX_i (t) \;\d t + \frac{1}{2} \sigma \;\d W_i (t)
$$

so that

$$
  X_i (t) = e^{-\alpha t/2} \left(X_i (0) + \frac{1}{2} \sigma\int_0^t e^{\beta s/2} \d W_i (s) \right)
$$

Consider the process $r_t = \sum_{i=1}^n X_i^2 (t)$. From Itô's differential rule

$$
  \d r_t =& \sum_{i=1}^n 2X_i (t) \left(-\frac{1}{2} \alpha X_i (t) \;\d t + \frac{1}{2} \sigma \;\d W_i (t) \right) + \sigma_{i=1}^n \frac{1}{4} \sigma^2 \;\d t \\
  =& -\alpha r_t \;\d t + \sigma\left(\sigma_{i=1}^n X_i (t) \;\d W_i (t) \right) + \frac{n\sigma^2}{4} \;\d t \\
  =& \left(\frac{n\sigma^2}{4} - \alpha r_t \right) \;\d t + \sigma\sqrt{r_t} \sum_{i=1}^n \frac{X_i (t)}{\sqrt{r_t}} \;\d W_i (t)
$$

Consider the process

$$
  W_t = \sum_{i=1}^n \int_0^t \frac{X_i (u)}{\sqrt{r_u}} \;\d W_i (u)
$$

Then $W$ is a continuous martingale and

$$
\begin{align*}
  W_t^2 = 2\int_0^t W_u \;\d W_u + \sum_{i=1}^n \int_0^t \frac{X_i^2}{r_u} \;\d u \\
  =& 2\int_0^t W_u \;\d W
\end{align*}
$$

so $W_t^2 - t$ is a martingale. From Lévy's characterization, therefore, $W$ is a standard Brownian motion and we can write

$$
  \d r_t = \left(\frac{n\sigma^2}{4} - \alpha r_t \right) \d t + \sigma\sqrt{r_t} \;\d W_t
$$

If $n = 1$, then $\mathbb{P}(r_t > 0) = 1$ but

$$
  \mathbb{P}(\text{there are infinitely many times } t > 0 \text{ for which } r_t = 0) = 1
$$

However, if $n \geq 2$, then

$$
  \mathbb{P}(\text{there are at least one time } t > 0 \text{ for which } r_t = 0) = 0
$$

<MathBox title='Cox-Ingersoll-Ross process' boxType='definition'>
A Cox-Ingersoll-Ross process is described by an equation of the form

$$
\begin{equation*}
  \d r_t = (a - br_t) \d t + \sigm\sqrt{r_t} \d W_t
\tag{\label{equation-37}}
\end{equation*}
$$

where $a, b, \sigma > 0$ are constant.
</MathBox>

With $n = 4a/\sigma^2$, we can interpret $r_t$ as $\sigma_{i=2}^n X_i^2 (t)$ for Ornstein-Uhlenbeck process $X_i$ as above. However, $\eqref{equation-37}$ makes sense whether or not $n$ is an integer.

If $a < \sigma^2 /2$, so $n < 2$, then

$$
  \mathbb{P}(\text{there are infinitely many times } t > 0 \text{ for which } r_t = 0) = 1
$$

Consequently, this range for $a$ is not too useful. If $a \geq $\sigma^2 /2$, so $n\geq 2$, then

$$
  \mathbb{P}(\text{there is at least one time } t > 0 \text{ for which } r_t = 0) = 0
$$

<MathBox title='' boxType='theorem'>
For any $\lambda > 0$ and $\mu > 0$ we have

$$
  \mathbb{E}\left[\exp\left(-\lambda r_{0,t} (x) - mu\int_0^t r_{0,u} \;\d u) \right] = e^{-a\phi_{\lambda,\mu} (t)} e^{-x\psi_{\lambda, \mu} (t)}
$$

where

$$
\begin{align*}
  \phi_{\lambda, u} (t) = -\frac{2}{\sigma^2} \ln\left(\frac{2\gamma e^{t(b + \gamma)/2}}{\sigma^2 \lambda (e^{\gamma t} - 1) + \gamma - b + e^{\gamma t} (\gamma + b)}\right) \\
  =& \psi_{\lambda, u} (t) = \frac{\lambda(\gamma + b) + e^{-\gamma t} (\gamma - b) + 2\mu(e^{\gamma t} - 1)}{\sigma^2 \lambda (e^{\gamma t} - 1) + \gamma - b + e^{\gamma t} (\gamma + b)}
\end{align*}
$$

and $\gamma = \sqrt{b^2 + 2\sigma^2 \mu}$.

<details>
<summary>Proof</summary>

Suppose $0 \leq t \leq T$. From the uniqueness of solutions of $\eqref{equation-37}$, we have the following flow property

$$
  r_{0, T} (x) = r_{t, T} (r_{0, t} (x))
$$

Consider the expectation

$$
  \mathbb{E}\left[\exp\left(-\lambda r_{t, T} (r_{0, T} (x)) - \mu \int_t^T r_{0,u} (x) \;\d\mu \right)\middle| \mathcal{F}_t \right]
$$

From the Markov property, this is the same as conditioning on $r_{0,t} (x)$, so write

$$
  V(t, r_{0,t} (x)) = \mathbb{E}\left[\exp\left(-\lambda r_{0, T} (x) - \mu \int_t^T r_{0,u} (x) \;\d u \right) \right]
$$

Now

$$
  \exp(-\mu\int_0^t r_{0,u} (x)\;\d u) V(t, r_{0,t} (x)) = \mathbb{E}\left[\exp\left(-\lambda r_{t, T} (r_{0, T} (x)) - \mu \int_t^T r_{0,u} (x) \;\d\mu \right)\middle| \mathcal{F}_t \right]
$$

and so is a martingale. However, applying the Itô differentiation rule, we obtain

$$
\begin{align*}
  & \exp(-\mu\int_0^t r_{0,u} (x)\;\d u) V(t, r_{0,t} (x)) \\
  =& V(0,x) + \int_0^t \left(\frac{\partial V}{\partial u}(u, r_{0,u}) (x) - \mu r_{0,u} (x) V(u, r_{0,u} (x)) \right. \\
  &+ \frac{\partial V}{\partial\xi} (u, r_{0,u} (x))(a - br_{0,u} (x)) \\
  &+ \left. \frac{1}{2}\frac{\partial^2 V}{\partial\xi^2} (u, r_{0,u} (x)) \sigma^2 r_{0,u} (x) \right) \exp\left(-\mu\int_0^u r_{0,s} (x) \;\d s \right) \;\d u \\
  &+ \int_0^t \exp\left(-\mu\int_0^u r_{0,s} (x) \;\d s \right) \frac{\partial V}{\partial\xi} (u, r_{0,u} (x)) \sigma\sqrt{r_{0,u} (x)} \;\d W_u
\end{align*}
$$

As the left-hand side is a martingale and the right-hand side is an Itô prcess, the du integral must be the zero process. Thus,
 
$$
  \frac{\partial V}{\partial t}(t, y) - \mu y V(t, y) + \frac{\partial V}{\partial y} (t, y) (a - by) + \frac{1}{2}\frac{\partial^2 V}{\partial y^2} (t, y)\sigma^2 y = 0
$$

with

$$
  V(t, y) = \mathbb{E}\left[\exp\left(-\lambda r_{t, T} (y) - \mu\int_t^T r_{t, u} (y) \;\d u \right)\right]
$$

Since the the coefficients of $\eqref{equation-37}$ are independent of $t$, its solution is stationary and we can write

$$
  V(t, y) = \mathbb{E}\left[\exp\left(-\lambda r_{0, T - t} (y) - \mu\int_0^{T - t} r_{0, u} (y) \;\d u \right)\right]
$$

Define

$$
  F(t, y) = \mathbb{E}\left[\exp\left(-\lambda r_{0, t} (y) - \mu\int_0^t r_{0, u} (y) \;\d u \right)\right]
$$

so that $V(t,y) = F(T - t, y)$ and $F$ satisfies

$$
\begin{equation*}
  \frac{\partial F}{\partial t} = \frac{\partial F}{\partial y} (a - by) - \mu y F + \frac{1}{2} \sigma^2  y\frac{\partial^2 F}{\partial y^2}
\tag{\label{equation-38}}
\end{equation*}
$$

with $F(0,y) = e^{-\lambda y}$.

We look for a solution of $\eqref{equation-38}$ of the form

$$
  F(t, y) = e^{-a\phi(t) - x\psi(t)}
$$

This is the case if $\phi(0) = 0$ and $\psi(0) = \lambda$ with

$$
  \phi' (t) = \psi(t),\quad -\psi' (t) = \frac{\sigma^2}{2} \psi^2 (t) + b\psi(t) - \mu
$$

Solving these equations gives the expression for $\phi$ and $\psi$.
</details>
</MathBox>

Taking $\mu = 0$, we obtain the Laplace transform of $r_t (x)$

$$
  \mathbb{E} \left(e^{\lambda r_t (x)}\right) = (2\lambda K + 1)^{-2a/\sigma^2} \exp\left(\frac{-\lambda K z}{2\lambda K + 1}\right)
$$

where

$$
  K = \frac{\sigma^2}{4b} (1 - e^{-bt}),\quad z = \frac{4bx}{\sigma^2 (e^{bt} - 1)}
$$

Consequently, the Laplace transform of $r_t (x) / K$ is given given by $g_{4g/\sigma^2, z}$, where

$$
  g_{\delta, z} = \frac{1}{(2\lambda + 1)^{\delta/2}} \exp\left(-\frac{\lambda}{2\lambda + 1}\right)
$$

However, consider the chi-square density $f_{\delta, z}$, having $\delta$ degress of freedom and decentral parameter $z$, given by

$$
  f_{\delta, z} (x) = \frac{e^{-z/2}}{2z^{\delta/4 - 1/2}} e^{-x/2} x^{\delta/4 - 1/2} I_{\delta/2 - 1} (\sqrt{xz}),\; x > 0
$$

Here $I_\nu$ is the modified Bessel function of order $\nu$, given by

$$
  I_\nu (x) = \left(\frac{x}{2}\right)^\nu \sum_{n=0}^\infty \frac{\left(\frac{x}{2} \right)^{2n}}{n! \Gamma(\nu + n + 1)}
$$

Then it can be shown that $g_{\delta, z}$ is the Laplace transform of the law of a random variable having density $f_{\delta, z} (x)$. Consequently, $r_t (x)/K$ is a random variable having a chi-square density with $\delta$ degrees of freedom.

Under a risk-neutral measure $\mathbb{P}$, the price of a zero coupon bond at time $t = 0$ is

$$
\begin{align*}
  B(0,T) =& \mathbb{E}\left[\exp\left(-\int_0^T r_u (x) \;\d u \right)\right] \\
  =& e^{-a\phi_{0,1} (0,T) - r_0 (x) \psi_{0,1} (0,T)}
\end{align*}
$$

where

$$
\begin{align*}
  \phi_{0,1} (T) =& -\frac{2}{\sigma^2} \ln\left(\frac{2\gamma e^{T(\gamma + b)/2}}{\gamma - b + e^{\gamma T}(\gamma + b)} \right) \\
  \psi_{0,1} (T) =& \frac{2(e^{\gamma T} - 1)}{\gamma - b + e^{\gamma T} (\gamma + b)}
\end{align*}
$$

with $\gamma = \sqrt{b^2 + 2\sigma^2}$. The price of a zero coupon bond at time $t$ is similarly, because of stationarity

$$
  B(t, T) = e^{-a \phi_{0,1} (T - t) - r_t (x) \psi_{0,1} (T - t)}
$$

Suppose $0 \leq T \leq T^*$. Consider a European call option with expiration time $T$ and strike price $K$ on the zero coupon bond $B(t, T)^*$. At time $0$, this a price

$$
\begin{align*}
  V_0 =& \mathbb{E}\left[\exp\left(-\int_0^T r_u (x) \;\d u \right) (B(T,T^*) - K)^+ \right] \\
  =& \mathbb{E}\left(\mathbb{E}\left[\exp\left(-\int_0^T r_u (x) \;\d u \right) (B(T,T)^* - K)^+ \middle| \mathcal{F}_t \right]\right) \\
  =& \mathbb{E}\left[\exp\left(-\inf_0^T r_u (x) \;\d x \right) \left(e^{-a\phi_{0,1} (T^* - T) - r_T (x) \psi_{0,1} (T^* - T)} - K \right)^+ \right]
\end{align*}
$$

Write

$$
  r^* = \frac{-a\phi_{0,1} (T^* - T) + \ln(K)}{\psi_{0,1} (T^* - T)}
$$

Then

$$
\begin{align*}
  V_0 =& \mathbb{E}\left[ \exp\left(-\int_0^T r_u (x) \;\d u \right) B(T,T^*) \mathbf{1}_{r_T (x) < r^*} \right] \\
  &- K\mathbb{E}\left[\exp\left(-\int_0^T r_u (x) \;\d u \right) \mathbf{1}_{r_T (x) < r^*}\right]
\end{align*}
$$

Now

$$
\begin{align*}
  \mathbb{E}\left[\exp\left(-\int_0^T r_u (x) \;\d u \right) B(T, T^*) \right] =& B(0,T^*) \\
  \mathbb{E}\left[\exp\left(-\int_0^T r_u (x) \;\d u \right) \right] =& B(0, T)
\end{align*}
$$

Define two new probability measures $\mathbb{P}_1$ and $\mathbb{P}_2$ by setting

$$
\begin{align*}
  \left.\frac{\d\mathbb{P}_1}{\d P}\right|_{\mathcal{F}_T} =& \frac{\exp\left(-\int_0^T r_u (x) \;\d u \right) B(T, T^*)}{B(0,T^*)}
  \left.\frac{\d\mathbb{P}_2}{\d P}\right|_{\mathcal{F}_T} =& \frac{\exp\left(-\int_0^T r_u (x) \;\d u \right)}{B(0,T)}
\end{align*}
$$

Then

$$
  V_0 = B(0,T^*) \mathbb{P}_1 (r_T (x) < r^*) - K B(0,T) \mathbb{P}_2 (r_T (x) < r^*)
$$

Write

$$
\begin{align*}
  K_1 =& \frac{\delta^2}{2} \frac{e^{\gamma_T} - 1}{\gamma (e^{\gamma_T} + 1) + (\sigma^2 \psi_{0,1} (T^* - T) + b)(e^{\gamma_T} - 1)} \\
  K_2 =& \frac{\sigma^2}{2} \frac{e^{\gamma_T} - 1}{\gamma (e^{\gamma_T} + 1) + b(e^{\gamma_T} - 1)}
\end{align*}
$$

Then it can be shown that the law of $r_T (x)/K_1$ under $\mathbb{P}_1$ (respectively, the law of $r_T (x)/K_2$ under $\mathbb{P}_2$) is a decentral chi-square with $4a/\sigma^2$ degrees of freedom and decentral parameter $\xi_1$ (respectively, $\xi_2$), where

$$
\begin{align*}
  \xi_1 =& \frac{8r_0 (x) \gamma^2 e^{\gamma_T}}{\sigma^2 (e^{\gamma_T} - 1)(\gamma (e^{\gamma_T} + 1)) + (\sigma^2 \psi_{0,1} (T^* - T) + b)(e^{\gamma_T} - 1)} \\
  \xi_2 =& \frac{8r_0 (x) \gamma^2 e^{\gamma_T}}{\sigma^2 (e^{\gamma_T} - 1)(\gamma(e^{\gamma_T} + 1) + b(e^{\gamma_T} - 1))}
\end{align*}
$$

Consequently, if $F_{\delta, z}$ is the probability distribution function for a chi-square random variable with $\delta$ degrees of freedom and decentral parameter $z$, then

$$
  V_0 = B(0,T^*) F_{4a/\sigma^2, \xi_1} \left(\frac{r^*}{K_1}\right) - KB(0,T) F_{4a/\sigma^2, \xi_2} \left(\frac{r^*}{K_2}\right)
$$

# Pairs trading

## Optimal mean reversion stopping

Consider two risky assets with price $S_t^{(1)}$ and $S_t^{(2)}$ at time $t \geq 0$. We construct a mean-reverting porfolio with value

$$
  X_t^{\alpha,\beta} = \alpha S_t^{(1)} - \beta S_t^{(2)}
$$

where $\alpha, \beta \geq 0$ denote the position sizes (in shares) of the respective assets. The pair $(\alpha, \beta)$ represents a strategy adjusted to a level of mean-reversion. For the purpose of testing mean reversion, only the ratio between $\alpha$ and $\beta$ matters, so we can keep $\alpha$ constant while varying $\beta$ without loss of generality.

Let $(\Omega,\mathcal{F},\mathbb{P})$ be a probability space. The resulting portfolio process $X_t: \Omega\times\R\to\R$, generating the filtration $\mathscr{F} = (\mathcal{F}_t)_{t \geq 0}$, is modeled as an Ornstein-Uhlenbeck (OU) process driven by the stochastic differential equation

$$
\begin{equation*}
  \d X_t = \mu (\theta - X_t) \d t + \sigma \d W_t
\tag{\label{equation-1}}
\end{equation*}
$$

where
- $\mu$ the mean-reversion rate
- $\theta > 0$ is the long-run mean
- $\sigma > 0$ is the volatility
- $W_t$ is a standard Wiener process

Given a strategy $(\alpha, \beta)$, we observe a time series $(x_i^{\alpha,\beta})_{i=1}^n$ of realized porfolio values over $n$ discrete time intervals. We estimate the OU parameters $(\theta,\mu,\sigma)$ by maximum likelihood estimation, using the fact that the conditional probability density of $X_{t_i}$ give $X_{t_{i-1}}$ is Gaussian:

$$
  f(x_i | x_{i-1} ; \theta, \mu, \sigma) = \frac{1}{\sqrt{2\pi\tilde{\sigma}}} \exp\left(-\frac{(x_i - x_{i-1} e^{-\mu\Delta t} - \theta(1 - e^{-\mu\Delta t}))^2}{2\tilde{\sigma}^2} \right)
$$

where $\Delta t = t_i - t_{i-1}$ and

$$
  \tilde{\sigma}^2 = \sigma^2 \frac{1 - e^{-2\mu\Delta t}}{2\mu}
$$

The average log-likelihood over the sample path is given by

$$
\begin{align*}
  \ell (\theta,\mu,\sigma|x_0^{\alpha,\beta},\dots,x_n^{\alpha, \beta}) :=& \frac{1}{n} \sum_{i=1}^n \ln[f(x_i^{\alpha,\beta} | x_{i-1}^{\alpha,\beta} ; \theta, \mu, \sigma)] \\
  =& -\frac{1}{2} \ln(2\pi) - \ln(\tilde{\sigma}) - \frac{1}{2n\tilde{\sigma}^2} \sum_{i=1}^n [x_i^{\alpha,\beta} - x_{i-1}^{\alpha,\beta} e^{-\mu\Delta t} - \theta(1 - e^{-\mu\Delta t})]^2
\end{align*}
$$

We denote by $\hat{l}(\theta^*, \mu^*, \sigma^*)$ the maximum average log-likelihood obtained over all admissible values of $(\theta, \mu, \sigma)$ for a given strategy $(\alpha, \beta)$. For a given $\alpha$, we select the optimal $\beta^*$ by solving 

$$
  \beta^* = \argmax_\beta \hat{l} (\theta^*,\mu^*,\sigma^* | x_0^{\alpha,\beta},\dots,x_n^{\alpha,\beta})
$$

and define the optimal strategy $(\alpha,\beta^*)$.

### Optimal double stopping problem

We are interested in finding the optimal timing to enter and subsequently exit a portfolio position, accounting for transaction costs. This leads to a double stopping problem.

**Exit timing**

Suppose the investor holds an existing position with value process $(X_t)_{t\geq 0}$ given by the OU process $\eqref{equation-1}$. If the position is closed (liquidated) at some stopping time $\tau$, the investor will receive the terminal value $X_\tau$ and pay a fixed transaction cost $c\in\R_+$. The maximum expected discounted value starting from $X_0 = x$ is given by optimal stopping problem

$$
\begin{equation*}
  V(x) = \sup_{\tau\in\mathcal{T}} \mathbb{E}_x [e^{-r\tau} (X_\tau - c)]
\tag{\label{equation-11}}
\end{equation*}
$$

where 
- $\mathcal{T}$ is the set of all $\mathscr{F}$-stopping times
- $r > 0$ is the investor's subjective constant discount rate
- $\mathbb{E}_x = \mathbb{E}[\cdot| X_0 = x]$ denotes the conditional expectation

**Entry timing**

Before entering the position, the investor can choose the optimal time - or opt not enter at all - based on the expected profit from a future optimal exist. Entering at time $\nu$ incurs upfront transaction cost $\hat{c}\in\R_+$ and a purchase price $X_\nu$. The maximum expected discounted return of the investment opportunity considering both entry and exit costs is given by

$$
\begin{equation*}
  J(x) = \sup_{\nu\in\mathcal{T}} \mathbb{E}_x [e^{\hat{r}\nu} (V(X_\nu) - X_\nu -\hat{c})]
\tag{\label{equation-12}}
\end{equation*}
$$

where $\hat{r} > 0 \in\R$ is the pre-entry discount rate. We allow for differing entry and exit parameters, provided:
- $0 < \hat{r} \leq r$ (discounting is at least as strong after entry),
- $c + \hat{c} > 0$ (overall transaction cost is non-zero).

Since infinite stopping times $\tau = \infty$ and $\nu = \infty$ are admissible, both value functions are nonnegative, i.e.

$$
  V(x) \geq 0,\quad J(x) \geq 0
$$

**Stop-loss constraint**

As extension, we can incorporate a stop-loss level $L$ of the pairs trade, representing a lower bound on the acceptable loss. If the portfolio value $X$ ever reaches level $L$, the position is forcibly closed. The stop-loss constraint is modeled via the first hitting time

$$
  \tau_L := \inf\set{t \geq 0 : X_t \leq L}
$$

Thus, we determine the entry and liquidation timing from the constrained optimal stopping problem

$$
\begin{align*}
  J_L (x) =& \sup_{\nu\in\mathcal{T}} \mathbb{E}_x [e^{\hat{r}\nu} (V_L (X_\nu) - X_\nu -\hat{c})] \tag{\label{equation-23}} \\
  V_L (x) =& \sup_{\tau\in\mathcal{T}} \mathbb{E}_x [e^{-r(\tau\land\tau_L)} (X_{\tau\land\tau_L} - c)] \tag{\label{equation-24}}
\end{align*}
$$

where $\tau\land\tau_L = \min\set{\tau,\tau_L}$ accounts for the earlier of voluntary liquidation or stop-loss enforcement.

Due to the stop-loss constraint, the investor may be forced to exit at a less favorable level, reducing the achievable value. Thus, the value functions satisfy the inequalities: 

$$
  x - c \leq V_L (x) \leq V(x),\quad 0\leq J_L (x) \leq J(x)
$$

**Solution to the optimal stopping problem**

To solve the optimal stopping problem for the OU process $X$, we write its infinitesimal generator ass

$$
  \mathcal{L} = \frac{\sigma^2}{2}\frac{\d^2}{\d x^2} + \mu (\theta - x) \frac{\d}{\d x}
$$

We seek solutions to second-order linear ordinary differential equation 

$$
\begin{equation*}
  \mathcal{L}u(x) = ru(x),\; x\in\R
\tag{\label{equation-2}}
\end{equation*}
$$

which arise naturally in the analysis of expected discounted payoffs under OU dynamics. Two linearly independent solution to this equation are by the integral representations

$$
\begin{align*}
  F(x) \equiv F(x;r) :=& \int_0^\infty u^{r/\mu - 1} \exp\left(\sqrt{\frac{2\mu}{\sigma^2}} (x - \theta)u - \frac{u^2}{2} \right) \;\d u \\
  G(x) \equiv G(x;r) :=& \int_0^\infty u^{r/\mu - 1} \exp\left(\sqrt{\frac{2\mu}{\sigma^2}} (\theta - x)u - \frac{u^2}{2} \right) \;\d u
\end{align*}
$$

Direct differentation shows that
- $F'(x) > 0$ and $F''(x) > 0$
- $G'(x) < 0$ and $G''(x) > 0$
so , both $F(x)$ and $G(x)$ are strictly positive and convex, with $F$ strictly increasing and $G$ strictly decreasing.

Let $\tau_\kappa = \inf\set{t \geq 0 : X_k = \kappa}$ denote the first hitting time of level $\kappa$. The solutions $F$ and $G$ admit the probabilistic expression

$$
  \mathbb{E}_x (e^{-r\tau_\kappa}) = \begin{cases}
    \frac{F(x)}{F(\kappa)},\quad& x\leq\kappa \\
    \frac{G(x)}{G(\kappa)},\quad& x\geq\kappa
  \end{cases}
$$

Let $\tau_a \land \tau_b := \inf\set{t\geq 0 | X_t [a,b]}$ denote the first exit time from the interval $[a,b]$ with $-\infty \leq a \leq b \leq \infty$. Define the the reward function $h(x) = x - c$, representing the net liquidation payoff. The expected discounted reward from exiting the interval is therefore

$$
\begin{align*}
  \mathbb{E}_x [e^{-r(\tau_a \lor \tau_b)} h(X_{\tau_a \lor \tau_b})] =& h(a) \mathbb{E}_x [e^{-r\tau_a} \mathbf{1}_{\tau_a < \tau_b}] + h(b) \mathbb{E}_x [e^{-r\tau_a} \mathbf{1}_{\tau_a > \tau_b}] \\
  =& h(a) \frac{F(x)G(b) - F(b)G(x)}{F(a)G(b) - F(b)G(a)} + h(b) \frac{F(a)G(x) - F(x)G(a)}{F(a)G(b) - F(b)G(a)}
\end{align*}
$$

which follows from the fact that $f(x) := \mathbb{E}_x [e^{-r (\tau_a \land \tau_b)} \mathbf{1}_{\tau_a < \tau_b}]$ is the unique solution to $\eqref{equation-2}$ with boundary conditions $f(a) = 1$ and $f(b) = 0$. Similarly, $g(x) := \mathbb{E}_x [e^{-r (\tau_a \land \tau_b)} \mathbf{1}_{\tau_a > \tau_b}]$ is the solution to $\eqref{equation-2}$ with boundary conditions $g(a) = 0$ and $g(b) = 1$.

Applying the transformation $\psi(x) := F(x)/G(x)$, the expected discounted reward simplifies to

$$
  \mathbb{E}_x [e^{-r(\tau_a \lor \tau_b)} h(X_{\tau_a \lor \tau_b})] = G(x) \left[\frac{h(a)}{G(a)} \frac{\psi(b) - \psi(x)}{\psi(b) - \psi(a)} + \frac{h(b)}{G(b)} \frac{\psi(x) - \psi(a)}{\psi(b) - \psi(a)} \right]
$$

Substituting $y_a = \psi(a)$ and $y_b = \psi(b)$, and defining

$$
  H(y) := \begin{cases}
    \frac{h}{G} \circ\psi^{-1} (y),\quad& y > 0 \\
    \lim_{x\to\infty} \frac{(h(x))^2}{G(x)},\quad y = 0
  \end{cases}
$$

where $(h(x))^+ := \max\set{h(x), 0}$ denotes the positive part, we can express the expected discounted reward as a linear interpolation in the $\psi$-coordinate

$$
  \mathbb{E}_x [e^{-r(\tau_a \lor \tau_b)} h(X_{\tau_a \lor \tau_b})] = G[\psi^{-1} (y)] \left[H(y_a) \frac{y_b - y}{y_b - y_a} + H(y_b) \frac{y - y_a}{y_b - y_a} \right] \tag{\label{equation-4}}
$$

The final step is to determine the optimal exit interval $[a^*, b^*]$, which is found by maximizing the interpolated reward in $\eqref{equation-4}$ over admissible intervals $[y_a, y_b]$ containing $y = \psi(x)$. This leads to the envelope

$$
\begin{equation*}
  W(y) := \sup_{\set{y_a, y_b : y_a \leq y \leq y_b}} \left[H(y_a) \frac{y_b - y}{y_b - y_a} + H(y_b) \frac{y - y_a}{y_b - y_a} \right]
\tag{\label{equation-5}}
\end{equation*}
$$

which is the smallest concave majorant of $H(y)$. Thus, the value function for the optimal stopping problem is

$$
\begin{equation*}
  V(x) = G(x)W(\psi(x)) = \sup_{\set{a,b : a\leq x\leq b}} \mathbb{E}_x [e^{-r(\tau_a \lor\tau_b)} h(X_{\tau_a \lor \tau_b})]
\tag{\label{equation-6}}
\end{equation*}
$$

<details>
<summary>Proof</summary>

Since $\tau_a \land \tau_b \in \mathcal{T}$, we have $V(x) \geq \sup_{\set{a,b: a \leq x \leq b}} \mathbb{E}_x [e^{-r(\tau_a \land\tau_b)}h(X_{\tau_a \land\tau_b})] = G(x)W(\psi(x))$.

To show the reverse inequality, we first show that $G(x)W(\psi(x)) \geq \mathbb{E}_x \set{e^{-r(t\land\tau)}G(X_{t\land\tau})W(\psi(X_{t\land\tau}))}$, for $\tau\in\mathcal{T}$ and $t\geq 0$. The concavity of $W$ implies that, for any fixed $y$, there exists an affine function $L_y(z) := m_y z + c_y$ such that $L_y(z) \geq W(z)$ and $L_y(y) = W(y)$ at $z = y$, where $m_y$ and $c_y$ are both constants depending on $y$. This leads to the inequality

$$
\begin{align*}
  \mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})W(\psi(X_{t\land\tau}))] \leq& \mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})L_{\psi(x)}(\psi(X_{t\land\tau}))]  \\
  =& m_{\psi(x)}\mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})\psi(X_{t\land\tau})] \\
  &+ c_{\psi(x)} \mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})] \\
  =& m_{\psi(x)}\mathbb{E}_x [e^{-r(t\land\tau)}F(X_{t\land\tau})]+ c_{\psi(x)} \mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})] \\
  =& m_{\psi(x)}F(x) + c_{\psi(x)} G(x) \tag{\label{equation-30}} \\
  =& G(x) L_{\psi(x)}(\psi(x)) \\
  =& G(x)W(\psi(x)) \tag{\label{equation-31}}
\end{align*}
$$

where $\eqref{equation-30}$ follows from the martingale property of $(e^{-rt}F(X_t))_{t\geq 0}$ and $(e^{-rt} G(X_t))_{t\geq 0}$.

By $\eqref{equation-31}$ and the fact that $W$ majorizes $H$, it follows that

$$
\begin{align*}
  G(x)W(\psi(x)) \geq& \mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})W(\psi(X_{t\land\tau}))] \\
  \geq& \mathbb{E}_x [e^{-r(t\land\tau)}G(X_{t\land\tau})H(\psi(X_{t\land\tau}))] \\
  =& \mathbb{E}_x [e^{-r(t\land\tau)}h(X_{t\land\tau})] \tag{\label{equation-32}}
\end{align*}
$$

Maximizing $\eqref{equation-32}$ over all $\tau\in\mathcal{T}$ and $t\geq 0$ yields that $G(x)W(\psi(x)) \geq V(x)$.
</details>

<MathBox title='' boxType='remark'>
If $a = -\infty$, then we have $\tau_a = \infty$ and $\mathbf{1}_{\tau_a < \tau_b} = 0$ almost surely. In effect, this removes the lower exit level, and the corresponding discounted reward is

$$
\begin{align*}
  \mathbb{E}_x [e^{-r(\tau_a \lor\tau_b)} h(X_{\tau_a \lor \tau_b})] =& \mathbb{E}_x [e^{-r\tau_a} h(X_{\tau_a}) \mathbf{1}_{\tau_a < \tau_b}] + \mathbb{E}_x [e^{-r\tau_b} h(X_{\tau_a}) \mathbf{1}_{\tau_a > \tau_b}] \\
  =& \mathbf{E}_x [e^{-\tau_b} h(X_{\tau_b})]
\end{align*}
$$

Consequently, by considering interval-type strategies, we also inlcude the class of stopping strategies of reaching a single upper level $b$.
</MathBox>

To find a solution for the value function $J$ in $\eqref{equation-5}$ corresponding to the optimal entry timing problem, we proceed analogously to the stopping case above. In terms of the pre-entry dicount rate $\hat{r}$, define the associated fundamental functions $\hat{F}(x) = F(x;\hat{r})$ and $\hat{G}(x) = G(x;\hat{r})$, along with the corresponding transformations

$$
\begin{equation*}
  \hat{\psi(x)} := \frac{\hat{F}}{\hat{G}}(x),\quad \hat{x} = V(x) - x - \hat{c}
\tag{\label{equation-18}}
\end{equation*}
$$

In terms of the transformed variables, we define the analog to the function $H$

$$
\begin{equation*}
  H(y) := \begin{cases}
    \frac{\hat{h}}{\hat{G}} \circ\hat{\psi}^{-1} (y),\quad& y > 0 \\
    \lim_{x\to-\infty} \frac{(\hat{h}(x))^+}{\hat{G}(x)},\quad& y = 0
  \end{cases}
\tag{\label{equation-19}}
\end{equation*}
$$

Following the same reasoning as before, the smallest concave majorant $\hat{W}$ of $\hat{H}$ is given by the supremum of affine intepolants:

$$
  \hat{W}(y) := \sup_{\set{y_{\hat{a}}, y_{\hat{b}} : y_{\hat{a}} \leq y \leq y_{\hat{b}}}} \left[\hat{H}(y_{\hat{a}}) \frac{y_{\hat{b}} - y}{y_{\hat{b}} - y_{\hat{a}}} + \hat{H}(y_{\hat{b}}) \frac{y - y_{\hat{a}}}{y_{\hat{b}} - y_{\hat{a}}} \right]
$$

The optimal entry interval corresponds to the interval $(y_{\hat{a}^*}, y_{\hat{b}^*})$ in the $y = \hat{\psi}(x)$, where $\hat{W}$ touches the majorant. Hence the value function for the entry problem is given by

$$
\begin{equation*}
  J(x) = \hat{G}(x)\hat{W}(\hat{\psi(x)})
\tag{\label{equation-21}}
\end{equation*}
$$

<MathBox title='' boxType='remark'>
An alternative way to solve for $V(x)$ and $J(x)$ is to look for the solutions to the pair of variational inequalities

$$
\begin{align*}
  \min\set{rV(x) - \mathcal{L}V(x), V(x) - (x - c)} =& 0 \\
  \min\set{\hat{r}J(x) - \mathcal{L}J(x), J(x) - (V(x) - x - \hat{c})} =& 0
\end{align*}
$$

With sufficient regularity conditions, this approach can verify that the solutions to $V(x)$ an d$J(x)$ correspond to the optimal stopping problems. Nevertheless, this approach does not immediately suggest candidate optimal timing strategies or value functions, and typically begins with a conjecture on the structure of the optimal stopping time, followed by verification.
</MathBox>

### Optimal exit timing

<MathBox title='Properties of $H$' boxType='proposition' tag='proposition-1'>
The function $H:[0,\infty) \to\R$ is continuous on $[0,\infty)$, twice differentiable on $(0,\infty)$, and has the following properties
1. $H(0) = 0$ and
$$
  H(y) \begin{cases}
    < 0,\quad& y \in (0,\psi(c)) \\
    > 0,\quad& y \in (\psi(c), \infty)
  \end{cases}
$$
2. Let $x^*$ be the unique solution to $G(x) - (x - c)G'(x) = 0$. Then $H$ is
    - strictly decreasing if $y\in (0,\psi(x^*))$
    - strictly increasing if $y\in (\psi(x^*), \infty)$
and $x^* < c \land L^*$ with
$$
  L^* = \frac{\mu\theta + rc}{\mu + r}
$$
3. $H$ is
    - convex if $y\in(0,\psi(L^*)]$
    - concave if $y\in [\psi(L^*), infty)$

<details>
<summary>Proof</summary>

The continuity and twice differentiability of $H$ on $(0,\infty)$ follow directly from those of $h$, $G$ and $\psi$. It remains to show the continuity of $H$ at $0$. Since 

$$
  H(0) = \lim_{x\to -\infty} \frac{(x - c)^+}{G(x)} = 0
$$

we only need to shows that $\lim_{y\to 0} H(y) = 0$. Note that $y = \psi(x) \xrightarrow{x\to -\infty} 0$. Thus

$$
  \lim_{y\to 0} H(y) = \lim_{x\to -\infty} \frac{h(x)}{G(x)} = \lim_{x\to -\infty} \frac{x - c}{G(x)} = \lim_{x\to -\infty} \frac{1}{G'} = 0
$$

showing that $H$ is continuous at $y = 0$.

**(1):** Since $\psi(x) \in (0,\infty)$ for $x\in\R$ and is a strictly increasing function. Then **(1)** follows directly from the fact that $G(x) > 0$.

**(2):** By the definition of $H$

$$
  H'(y) = \frac{1}{\psi'(x)} \left(\frac{h}{G}\right)' (x) = \frac{h'(x) G(x) - h(x)G'(x)}{\psi'(x) G^2 (x)}
$$

Since both $\psi'(x)$ and $G^2(x)$ are positive, we only need to determine the sign of the nominator $h'(x) G(x) - h(x)G'(x) = G(x) - (x - c)G'(x)$. Define $u(x) := (x - c) - \frac{G(x)}{G'(x)}$. Then $u(x) + c$ is the intersecting point at $x$ axis of the tangent line of $G(x)$. Since $G(x)$ is a positive, strictly decreasingand convex function, then $u(x)$ is strictly increasing and $\lim_{x\to -\infty} u(x) < 0$. Also, note that

$$
  u(c) = -\frac{G(c)}{G'(c)} > 0
$$

and

$$
\begin{align*}
  u(L^*) =& (L^* - c) - \frac{G(x)}{G'(x)} \\
  =& \frac{\mu}{r}(\theta - L^*) - \frac{G(L^*)}{G'(L^*)} \\
  =& -\frac{\sigma^2}{2r} \frac{G''(L^*)}{G'(L^*)} > 0
\end{align*}
$$

Thus, there exists a unique root $x^*$ that solves $u(x) = 0$ and $x^* < c \land L^*$ such that

$$
  G(x) - (x - c) G'(x) \begin{cases}
    < 0,\quad& x\in(-\infty, x^*) \\
    > 0,\quad& x\in(x^*, \infty)
  \end{cases}
$$

Hence, $H(y)$ is strictly decreasing if $y\in(0,\psi(x^*))$, and decreasing otherwise.

**(3):** By the definition of $H$

$$
  H''(y) = \frac{2}{\sigma^2 G(x) (\psi'(x))^2} (\mathcal{L} - r)h(x)
$$

Since $\sigma^2$, $G(x)$ and $(\psi'(x))^2$ are all positive, we only need to determine the sign of $(\mathcal{L} - r)h(x)$:

$$
\begin{align*}
  (\mathcal{L} - r)h(x) =& \mu(\theta - x) - r(x - c) \\
  =& (\mu\theta + rc) - (\mu + r)x \begin{cases}
    \geq 0,\quad& x\in(-\infty, L^*] \\
    \leq 0,\quad& x\in[L^*, \infty)
  \end{cases}
\end{align*}
$$

Hence, $H(y)$ is convex if $y\in(0,\psi(L^*))$, and concave otherwise.
</details>
</MathBox>

<MathBox title='Optimal exit solution' boxType='theorem' tag='theorem-1'>
The optimal exit problem $\eqref{equation-11}$ admits the solution

$$
\begin{equation*}
  V(x) = \begin{cases}
    (b^* - c) \frac{F(x)}{F(b^*)},\quad& x\in(-\infty, b^*) \\
    x - c,\quad& \text{otherwise}
  \end{cases}
\tag{\label{equation-12}}
\end{equation*}
$$

where the optimal exit level $b^*$ is found from the equation

$$
\begin{equation*}
  F(b) = (b - c) F'(b)
\tag{\label{equation-13}}
\end{equation*}
$$

and is bounded below by $L^* \lor c$. The corresponding optimal exit time is given by

$$
  \tau^* = \inf\set{t \geq 0 : X_t \geq b^*}
$$

<details>
<summary>Proof</summary>

From Proposition $\ref{proposition-1}$ and the fact that $H'(y) \xrightarrow{y\to\infty} 0$, we infer that there exists a unique number $z > \psi(L^*) \lor \psi(c)$ such that

$$
\begin{equation*}
  \frac{H(z)}{z} = H'(z)
\tag{\label{equation-7}}
\end{equation*}
$$

In turn, the smallest concave majorant is given by

$$
\begin{equation*}
  W(y) = \begin{cases}
    y\frac{H(z)}{z},\quad& y < z \\
    H(y),\quad& y \geq z
  \end{cases}
\tag{\label{equation-8}}
\end{equation*}
$$

Substituting $b^* = \psi^{-1} (z)$ into $\eqref{equation-7}$, we get the left-hand side

$$
\begin{equation*}
  \frac{H(z)}{z} = H'(z) = \frac{H(\psi(b^*))}{\psi(b^*)} = \frac{b^* - c}{F(b^*)}
\tag{\label{equation-9}}
\end{equation*}
$$

and the right-hand side

$$
\begin{align*}
  H'(z) =& \frac{G(\psi^{-1} (z)) - (\psi^{-1} (z) - c)G'(\psi^{-1} (z))}{F'(\psi^{-1} (z)) G(\psi^{-1} (z)) - F(\psi^{-1}(z)) G'(\psi^{-1} (y))} \\
  =& \frac{G(b^*) - (b^* - c)G'(b^*)}{F'(b^*) G(b^*) - F(b^*) G'(b^*)}
\end{align*}
$$

Equivalently, we can express $\eqref{equation-7}$ in terms of $b^*$:

$$
  \frac{b^* - c}{F(b^*)} = \frac{G(b^*) - (b^* - c)G'(b^*)}{F'(b^*)G(b^*) - F(b^*)G'(b^*)}
$$

which further simplifies to

$$
  F(b^*) = (b^* - c) F'(b^*)
$$

Applying $\eqref{equation-9}$ to $\eqref{equation-8}$, we get

$$
\begin{equation*}
  W(\psi(x)) = \begin{cases}
    \psi(x) \frac{H(z)}{z} = \frac{F(x)}{G(x)} \frac{b^* - c}{F(b^*)},\quad& x < b^* \\
    H(\psi(x)) = \frac{x - c}{G(x)},\quad& x\geq b^* 
  \end{cases}
\tag{\label{equation-10}}
\end{equation*}
$$

In turn, we obtain the value function $V(x)$ by substituting $\eqref{equation-10}$ into $\eqref{equation-6}$.
</details>
</MathBox>

<MathBox title='' boxType='proposition'>
The value function $V(x)$ of $\eqref{equation-11}$ is decreasing in the transaction cost $c\in\R$ for every $x\in\R$, and the optimal exit level $b^*$ is increasing in $c$.

<details>
<summary>Proof</summary>

For any $x\in\R$ and $\tau\in\mathcal{T}$, the corresponding expected discounted reward 

$$
  \mathbb{E}_x [e^{-r\tau} (X_\tau - c)] = \mathbb{E}_x [e^{-r\tau} X_\tau] - c\mathbb{E}_x [e^{-r\tau}]
$$

is decreasingin $c$. This implies that $V(x)$ is also decreasing in $c$. Next, we treat the optimal threshold $b^* (c)$ as a function of $c$, and differentiate with respect to $c$ to get

$$
  {b^*}' (c) = \frac{F'(b^*)}{(b^* - c) F''(b^*)} > 0
$$

Since $F'(x) > 0$, $F''(x) > 0$ and $b^* > 0$ according to Theorem $\ref{theorem-1}$, we conclude that $b^*$ is increasing in $c$.
</details>
</MathBox>

#### With stop-loss

<MathBox title='Optimal exit timing solution with stop-loss' boxType='theorem' tag='theorem-3'>
The optimal liquidation problem $\eqref{equation-23}$ with stop-loss level $L$ admits the solution

$$
\begin{equation*}
  V_L(x) = \begin{cases}
    CF(x) + DG(x),\quad&  x\in (L,b_L^*) \\
    x - c,\quad& \textrm{ otherwise}
  \end{cases}
\tag{\label{equation-27}}
\end{equation*}
$$

where

$$
\begin{align}
  C =& \frac{(b_L^* - c)G(L) - (L - c)G(b_L^*) }{F(b_L^*)G(L) - F(L)G(b_L^*) } \\
  D =& \frac{(L - c)F(b_L^*)-(b_L^* - c)F(L)}{F(b_L^*)G(L) - F(L)G(b_L^*)}
\end{align}
$$

The optimal liquidation level $b_L^*$ is found from the equation

$$
\begin{equation*}
\begin{split}
  G(b)F(L) - G(L)F(b) =& [(L - c)G(b) - (b - c)G(L)]F'(b) \\
  &+ [(b - c)F(L) - (L - c)F(b)]G'(b) 
\end{split}
\tag{\label{equation-26}}
\end{equation*}
$$

<details>
<summary>Proof</summary>

Due to the stop-loss level $L$, we consider the smallest concave majorant of $H(y)$, denoted by $W_L(y)$, over the restricted domain $[\psi(L),\infty)$ and set $W_L(y) = H(y)$ for $y \in [0,\psi(L)]$.

From Proposition $\ref{proposition-1}$, we see that $H(y)$ is convex over $(0, \psi(L^*)]$ and concave in $[\psi(L^*),\infty)$. If $L
\geq L^*$, then $H(y)$ is concave over $[\psi(L),\infty)$, which implies that $W_L(y) = H(y)$ for $y\geq 0$, and thus $V_L(x) = x - c$ for $x\in\R$. On the other hand, if $L < L^*$, then $H(y)$ is convex on $[\psi(L),\psi(L^*)]$, and concave strictly increasing on $[\psi(L^*),\infty)$. There exists a unique number $z_L > \psi(L^*)$ such that

$$
\begin{equation*}
  \frac{H(z_L) - H(\psi(L))}{z_L-\psi(L)} = H'(z_L).
\tag{\label{equation-25}}
\end{equation*}
$$

In turn, the smallest concave majorant admits the form:

$$
\begin{equation*}
  W_L(y) = \begin{cases}
    H(\psi(L)) + (y-\psi(L))H'(z_L) &\, y\in (\psi(L), z_L),\\
    H(y) &\, \textrm{ otherwise. }
  \end{cases}
\tag{\label{equation-29}}
\end{equation*}
$$

Substituting $b_L^* = \psi^{-1}(z_L)$ into $\eqref{equation-25}$, we have from the left-hand side

$$
\begin{align*}
  \frac{H(z_L) - H(\psi(L))}{z_L-\psi(L)} =& \frac{H(\psi(b_L^*))- H(\psi(L))}{\psi(b_L^*)-\psi(L)} \\
  =& \frac{\frac{b_L^*-c}{G(b_L^*)} -\frac{L-c}{G(L)} }{ \frac{F(b_L^*)}{G(b_L^*)}- \frac{F(L)}{G(L)}} = C
\end{align*}
$$

and the right-hand side

$$
\begin{align*}
  H'(z_L) =& \frac{G(\psi^{-1}(z_L)) - (\psi^{-1}(z_L) - c)G'(\psi^{-1}(z_L))}{F'(\psi^{-1}(z_L))G(\psi^{-1}(z_L)) - F(\psi^{-1}(z_L)) G'(\psi^{-1}(z_L))} \\
  =& \frac{G(b^*_L) - (b^*-c)G'(b^*_L)}{F'(b^*_L)G(b^*_L) - F(b^*_L)G'(b^*_L)}
\end{align*}
$$

Therefore, we can equivalently express $\eqref{equation-25}$ in terms of $b_L^*$:

$$
  \frac{(b_L^*-c)G(L) - (L-c)G(b_L^*) }{F(b_L^*)G(L) - F(L)G(b_L^*)} = \frac{G(b_L^*) - (b_L^*-c)G'(b_L^*)}{F'(b_L^*)G(b_L^*) - F(b_L^*)G'(b_L^*)}
$$

which by rearrangement immediately simplifies to $\eqref{equation-26}$. Furthermore, for $x \in (L, b_L^*)$, $H'(z_L) = C$ implies that

$$
  W_L(\psi(x)) = H(\psi(L))+ (\psi(x) -\psi(L))C
$$

Substituting this to $V_L(x) = G(x)W_L(\psi(x))$, the value function becomes

$$
  V_L(x) = G(x) \big[H(\psi(L))+ (\psi(x) -\psi(L))C\big] = CF(x) + G(x)\big[H(\psi(L)) - \psi(L)C\big]
$$

which resembles $\eqref{equation-27}$ after the observation that

$$
\begin{align*}
  H(\psi(L)) - \psi(L)C =& \frac{L-c}{G(L)} - \frac{F(L)}{G(L)} \frac{(b_L^* - c)G(L) - (L - c)G(b_L^*) }{F(b_L^*)G(L) - F(L)G(b_L^*) }\\
  =& \frac{(L - c)F(b_L^*) - (b_L^* - c)F(L)}{F(b_L^*)G(L) - F(L)G(b_L^*)} = D
\end{align*}
$$
</details>
</MathBox>

We can interpret the investor's timing strategy in terms of three price intervals, namely, the liquidation region $[b^*_L, +\infty)$, the delay region $(L, b^*_L)$, and the stop-loss region $(-\infty, L]$. In both liquidation and stop-loss regions, the value function $V_L(x) = x-c$, and therefore, the investor will immediately close out the position. From the proof of Theorem $\ref{theorem-3}$, if $L \geq L^* = \frac{\mu \theta + r c}{\mu + r}$, then $V_L(x) = x-c$, for all $x\in\R$. In other words, if the stop-loss level is too high, then the delay region completely disappears, and the investor will liquidate immediately for every initial value $x\in\R$.

<MathBox title='' boxType='corollary'>
If $L < L^*$, then there exist a unique solution $b_L^* \in (L^*, \infty)$ that solves $\eqref{equation-26}$. If $L \geq L^*$, then $V_L (x) = x - c$, for $x\in\R$
</MathBox>

The direct effect of a stop-loss exit constraint is forced liquidation whenever the price process reaches $L$ before the upper liquidation level $b^*_L$. Interestingly, there is an additional indirect effect: a higher stop-loss level will induce the investor to *voluntarilty* liquidate earlier at a lower take-profit level.

<MathBox title='' boxType='proposition' tag='proposition-4'>
The optimal exit level $b_L^*$ of $\eqref{equation-24}$ strictly decreases as the stop-loss level $L$ increases.

<details>
<summary>Proof</summary>

Recall that $z_L = \psi(b_L^*)$ and $\psi$ is a strictly increasing function. Thus, it suffices to show that $z_L$ strictly decreases as $\tilde{L} := \psi(L)$ increases. As such, we denote $z_L(\tilde{L})$ to highlight its dependence on $\tilde{L}$. Differentiating $\eqref{equation-25}$ with respect to $\tilde{L}$ gives

$$
\begin{equation*}
  z'_L(\tilde{L}) = \frac{H'(z_L) - H'(\tilde{L})}{H''(z_L)(z_L - \tilde{L})}
\tag{\label{equation-28}}
\end{equation*}
$$

It follows from the definitions of $W_L$ and $z_L$ that $H'(z_L) > H'(\tilde{L})$ and $z_L > \tilde{L}$. Also, we have $H''(z) < 0$
since $H$ is concave at $z_L$. Applying these to $\eqref{equation-28}$, we conclude that $z'_L(\tilde{L}) < 0$.
</details>
</MathBox>

There is an interesting connection between cases with different long-run means $\theta$ and transaction costs $c$. To this end, let us denote the value function by $V_L(x;\theta,c)$ to highlight the dependence on $\theta$ and $c$, and the corresponding optimal liquidation level by $b_L^*(\theta,c)$. We find that, for any $\theta_1,\theta_2 \in \R$, $c_1, c_2 > 0$, $L_1 \leq\frac{\mu\theta_1 + rc_1}{\mu + r}$, and $L_2 \leq\frac{\mu\theta_2 + rc_2}{\mu + r}$, the associated value functions and optimal liquidation levels satisfy the relationships: 

$$
\begin{align}
  V_{L_1}(x + \theta_1;\theta_1,c_1) =& V_{L_2}(x + \theta_2;\theta_2,c_2) \\
  b_{L_1}^*(\theta_1,c_1) - \theta_1 =& b_{L_2}^*(\theta_2,c_2) - \theta_2
\end{align}
$$

as long as $\theta_1- \theta_2= c_1-c_2 = L_1- L_2$. These results also hold in the case without stop-loss.

### Optimal entry timing

<MathBox title='Properties of $\hat{H}$' boxType='proposition' tag='proposition-2'>
The function $\hat{H}:[0,\infty) \to\R$ is continuous on $[0,\infty)$, differentiable on $(0,\infty)$, and twice differentiable on $(0, \hat{\psi(b^*)})\cup (\hat{\psi(b^*)}, \infty)$ and has the following properties
1. $\hat{H}(0) = 0$. Let $\bar{d}$ be the unique solution to $\hat{h}(x) = 0$, then $\bar{d} < b^*$ and
$$
  \hat{H}(y) \begin{cases}
    < 0,\quad& y \in (0,\hat{\psi}(\bar{d})) \\
    > 0,\quad& y \in (\hat{\psi}(\bar{d}), \infty)
  \end{cases}
$$
2. $\hat{H}$ is strictly decreasing if $y \in (\hat{\psi(b^*)}, \infty)$
3. Let $\underline{b}$ denote the unique solution to $(\mathcal{L} - \hat{r})\hat{h}(x) = 0$, then $\underline{b} < L^*$ and $H$ is
    - convex if $y\in(0,\hat{\psi}(\underline{b})]$
    - concave if $y\in [\hat{\psi}(\underline{b}), infty)$

<details>
<summary>Proof</summary>

We first show that $V(x)$ and $\hat{x}$ are twice differentiable everywhere, except for $x = b^*$. Differentiating $V(x)$ in $\eqref{equation-12}$ and applying $\eqref{equation-13}$ yields

$$
  V'(x) = \begin{cases}
    (b^* - c)\frac{F'(x)}{F(b^*)} = \frac{F'(x)}{F'(b^*)},\quad& x\in(-\infty,b^*) \\
    1,\quad& x\in(b^*,\infty)
  \end{cases}
$$

which implies that $V'(b^*-) = 1 = V'(b^*+)$. Thus, $V(x)$ is differentiable everywhere and so is $\hat{h}(x) = V(x) - x - \hat{c}$. However, $V(x)$ is not twice differentiable because

$$
  V''(x) = \begin{cases}
    \frac{F''(x)}{F'(b^*)},\quad& x\in(-\infty,b^*) \\
    0,\quad& x\in(b^*,\infty)
  \end{cases}
$$

and $V''(b^*-) \neq V''(b^*+)$. Consequently, $\hat{h}(x) = V(x) - x - \hat{c}$ is not twice differentiable at $b^*$.

The twice differentiability of $\hat{G}$ and $\hat{\psi}$ are straightforward. The continuity and differentiability of $\hat{H}$ on $(0,\infty)$ and twice differentiability on $(0,\hat{\psi}(b^*))\cup(\hat{\psi}(b^*),\infty)$ follow directly. Noting that $\lim_{x\to-\infty} \hat{h}(x) > 0$, then $\hat{H}$ is also continuous at $0$ by definition. 

**(1):** First, we show that value of $\hat{H}$ at $0$

$$
\begin{align*}
  \hat{H}(0) =& \lim_{x\to-\infty} \frac{(\hat{h}(x))^+}{\hat{G}(x)} \\
  =& \limsup_{x\to -\infty} \frac{\frac{b^* - c}{F(b^*)} F(x) - x - \hat{c}}{\hat{G}(x)} \\
  =& \limsup_{x\to -\infty} \frac{\frac{b^* - c}{F(b^*)} F'(x) - x - \hat{c} - 1}{\hat{G}'(x)} = 0
\end{align*}
$$

Next, not that $\lim_{x\to -\infty} \hat{h}(x) = \infty$ and $\hat{h}(x) = -(c + \hat{c})$ for $x\in [b^*, \infty)$. Since $F'(x)$ is strictly increasing and $F'(x) > 0$ for $x\in\R$, we have, for $x < b^*$

$$
  \hat{h}'(x) = V'(x) - 1 = \frac{F'(x)}{F'(b^*)} - 1 < \frac{F'(b^*)}{F(b^*)} - 1 = 0
$$

which implies that $\hat{h}(x)$ is strictly decreasing for $x\in(-\infty,b^*)$. Thus, there exists a unique solution $\bar{d}$ to $\hat{h}(x) = 0$, and $\bar{d} < b^*$, such that $\hat{h}(x) > 0$ if $x\in(-\infty,\bar{d})$ and $\hat{h}(x) < 0$ if $x\in(\bar{d},\infty)$. It is trivial that $\hat{\psi}(x) \in (0,\infty)$ for $x\in\R$ and is a strictly increasing function. Along with the fact that $\hat{G}(x) > 0$, property **(1)** follows directly.

**(2):** With $y = \hat{\psi}(x)$ for $x > b^*$

$$
\begin{align*}
  \hat{H}'(x) =& \frac{1}{\psi'(x)} \left(\frac{\hat{h}}{\hat{G}}\right)' = \frac{1}{\hat{\psi'(x)}} \left(\frac{-(c + \hat{c})}{\hat{G}(x)}\right)' \\
  =& \frac{1}{\hat{\psi}'(x)} \frac{(c + \hat{c})\hat{G}'(x)}{\hat{G}^2 (x)} < 0
\end{align*}
$$

since $\hat{\psi}'(x) > 0$, $\hat{G}'(x) < 0$, and $\hat{G}^2 (x) > 0$. Thus, $\hat{H}(y)$ is strictly decreasing for $y > \hat{\psi}(b^*)$.

**(3):** The second derivative of $\hat{H}$ is

$$
  \hat{H}''(y) = \frac{2}{\sigma^2 \hat{G}(x)(\hat{\psi}'(x))^2}(\mathcal{L} - \hat{r})\hat{h}(x)
$$

Since $\sigma^2$, $\hat{G}(x)$ and $(\hat{\psi}'(x))^2$ are all positive, we only need to determine the sign of $(\mathcal{L} - \hat{r})\hat{h}(x)$:

$$
\begin{align*}
  (\hat{L} - \hat{r})\hat{h}(x) =& \frac{1}{2}\sigma^2 V''(x) + \mu(\theta - x) V'(x) - \mu(\theta - x) - \hat{r}(V(x) - x - \hat{c}) \\
  =& \begin{cases}
    (r - \hat{r}) V(x) + (\mu + \hat{r})x - \mu\theta + \hat{r}\hat{c},\quad& x < b^* \\
    \hat{r}(c + \hat{c}) > 0,\quad& x > b^*
  \end{cases}
\end{align*}
$$

To determine the sign of $(\hat{L} - \hat{r})\hat{h}(x)$ in $(-\infty, b^*)$, first not the $(\hat{L} - \hat{r})\hat{h}(x)$ is a strictly increasing function in $(-\infty, b^*)$, since $V(x)$ is a strictly increasing function and $r \geq \hat{r}$ by assumption. Next, not that for $x\in[L^*, b^*)$

$$
\begin{align*}
  (\hat{L} - \hat{r})\hat{h}(x) =& (r - \hat{r})V(x) + (\mu + \hat{r})x - \mu\theta + \hat{r}\hat{c} \\
  \geq& (r - \hat{r})(x - c) + (\mu + \hat{r})x - \mu\theta + \hat{r}\hat{c} \\
  =& (r + \mu)x - (\mu\theta + rc) + \hat{r}(c + \hat{c}) \\
  \geq& (r + \mu)L^* - (\mu\theta + rc) + \hat{r}(c + \hat{c}) = \hat{r}(c + \hat{c}) > 0
\end{align*}
$$

Also, note that $(\hat{L} - \hat{r})\hat{h}(x) \xrightarrow{x\to -\infty} -\infty$. Thus, $(\hat{L} - \hat{r})\hat{h}(x) < 0$ if $x\in(-\infty, \underline{b})$ and $(\hat{L} - \hat{r})\hat{h}(x) > 0$ if $x\in(\underline{b},\infty)$ with $\underline{b} < L^*$ being the break-even point.
</details>
</MathBox>

<MathBox title='Optimal entry solution' boxType='theorem' tag='theorem-2'>
The optimal entry timing problem $\eqref{equation-12}$ admits the solution

$$
\begin{equation*}
  J(x) = \begin{cases}
    V(x) - x - \hat{c},\quad& x \in (-\infty,d^*],\\
    \frac{V(d^*) - d^* - \hat{c}}{\hat{G}(d^*)}\hat{G}(x),\quad& x \in (d^*, \infty),
  \end{cases}
\tag{\label{equation-20}}
\end{equation*}
$$

where the optimal entry level $d^*$ is found from the equation

$$
\begin{equation*}
  \hat{G}(d)(V'(d) - 1) = \hat{G}'(d)(V(d) - d - \hat{c}).
\tag{\label{equation-15}}
\end{equation*}
$$

<details>
<summary>Proof</summary>

We look for the value function of the form: $J(x) = \hat{G}(x)\hat{W}(\hat{\psi}(x))$, where $\hat{W}$ is the the smallest concave majorant of $\hat{H}$. From Proposition $\ref{proposition-2}$, we infer that there exists a unique number $\hat{z} < \hat{\psi}(b^*)$ such that

$$
\begin{equation*}
  \hat{H}'(\hat{z}) = 0
\tag{\label{equation-14}}
\end{equation*}
$$

This implies that

$$
\begin{equation*}
  \hat{W}(y) = \begin{cases}
    \hat{H}(y),\quad& y \leq \hat{z} \\
    \hat{H}(\hat{z}),\quad& y > \hat{z}
  \end{cases}
\tag{\label{equation-16}}
\end{equation*}
$$

Substituting $d^* = \hat{\psi}^{-1}(\hat{z})$ into $\eqref{equation-14}$, we have

$$
  \hat{H}'(\hat{z}) = \frac{\hat{G}(d^*)(V'(d^*)  - 1) - \hat{G}'(d^*)(V(d^*)-d^*-\hat{c})}{\hat{F}'(d^*)\hat{G}(d^*)-\hat{F}(d^*)\hat{G}'(d^*)}=0
$$

which is equivalent to condition $\eqref{equation-15}$. Furthermore, using $\eqref{equation-18}$ and $\eqref{equation-19}$, we get

$$
\begin{equation*}
  \hat{H}(\hat{z}) = \frac{V(d^*) - d^* - \hat{c}}{\hat{G}(d^*)}
\tag{\label{equation-17}}
\end{equation*}
$$

To conclude, we substitute $\hat{H}(\hat{z})$ of $\eqref{equation-17}$ and $\hat{H}(y)$ of $\eqref{equation-18}$ into $\hat{W}$ of  $\eqref{equation-16}$, which by $\eqref{equation-21}$ yields the value function $J(x)$ in $\eqref{equation-20}$.
</details>
</MathBox>

<MathBox title='' boxType='proposition'>
The optimal entry level $d^*$ of $\eqref{equation-12}$ is decreasing in the transaction cost $\hat{c}$.

<details>
<summary>Proof</summary>

Considering the optimal entry level $d^*$ as a function of $\hat{c}$, we differentiate $\eqref{equation-15}$ with respect to $\hat{c}$ to get

$$
\begin{equation*}
  {d^*}'(\hat{c}) = \frac{-\hat{G}'(d^*)}{\hat{G}(d^*)} \left[V''(d^*)-\frac{V(d^*)-d^*-\hat{c}}{\hat{G}(d^*)}\hat{G}''(d^*)\right]^{-1}
\tag{\label{equation-22}}
\end{equation*}
$$

Since $\hat{G}(d^*) > 0$ and $\hat{G}'(d^*)< 0$, the sign of ${d^*}'(\hat{c})$ is determined by $V''(d^*) - \frac{V(d^*) -d^* - \hat{c}}{\hat{G}(d^*)}\hat{G}''(d^*)$. Denote $\hat{f}(x) = \frac{V(d^*) - d^* -\hat{c}}{\hat{G}(d^*)}\hat{G}(x)$. Recall that $\hat{h}(x) = V(x)-x-\hat{c}$

$$
  J(x) = \begin{cases}
    \hat{h}(x) &\, \textrm{ if }\, x \in (-\infty, d^*] \\
    \hat{f}(x)>\hat{h}(x) &\, \textrm{ if }\, x \in (d^*,+\infty)
  \end{cases}
$$

and $\hat{f}(x)$ smooth pastes $\hat{h}(x)$ at $d^*$. Since both $\hat{h}(x)$ and $ \hat{f}(x)$ are positive decreasing convex functions, it follows that $\hat{h}''(d^*)\leq \hat{f}''(d^*)$. Observing that $\hat{h}''(d^*) = V''(d^*)$ and $\hat{f}''(d^*) = \frac{V(d^*) - d^* - \hat{c}}{\hat{G}(d^*)}\hat{G}''(d^*)$, we have $V''(d^*)-\frac{V(d^*) -d^* -\hat{c}}{\hat{G}(d^*)}\hat{G}''(d^*) \leq 0$. Applying this to $\eqref{equation-22}$, we conclude that  ${d^{*}}^\prime\!(\hat{c}) \leq 0$.
</details>
</MathBox>

<MathBox title='' boxType='remark'>
Setting $\mu = 0$ in $\eqref{equation-1}$, with $r$ and $\hat{r}$ fixed, it follows that $X$ reduces to a standard Wiener process: $X_t = \sigma \d W_t$. In this case, the optimal exit level $b^*$ is

$$
  b^* = c + \frac{\sigma}{\sqrt{2r}}
$$

and the optimal entry level $d^*$ is the root to the equation

$$
  \left(1 + \frac{\hat{r}}{r} \right) \exp\left(\frac{\sqrt{2r}}{\sigma} (d - c - \frac{\sigma}{\sqrt{2r}}) \right) = \frac{\sqrt{2\hat{r}}}{\sigma} (d + \hat{c}) + 1,\; d\in (-\infty, b^*)
$$
</MathBox>

#### With stop-loss

Since  $\sup_{x\in\R}( V_L(x) - x - \hat{c})\leq 0$ implies that $J_L(x) = 0$ for $x\in\R$, we can focus on the case with

$$
  \sup_{x\in\R}( V_L(x)  -x - \hat{c})> 0
$$

and look for non-trivial optimal timing strategies.

Associated with reward function $\hat{h}_L(x) := V_L(x) - x - \hat{c}$ from entering the market, we define the function $\hat{H}_L$ whose properties are summarized in Proposition $\ref{proposition-3}$.

<MathBox title='Properties of $\hat{H}_L$' boxType='proposition' tag='proposition-3'>
The function $\hat{H}_L$ is continuous on $[0,+\infty)$, differentiable on $(0,\hat{\psi}(L)) \cup (\hat{\psi}(L), \infty)$, twice differentiable on $(0,\hat{\psi}(L)) \cup (\hat{\psi}(L),\hat{\psi}(b^*_L)) \cup (\hat{\psi}(b^*_L),\infty)$, and has the following properties:
1. $\hat{H}_L(0) = 0$ and $\hat{H}_L(y) < 0$ for $y \in (0, \hat{\psi}(L)]\cup [\hat{\psi}(b_L^*),\infty)$
2. $\hat{H}_L(y)$ is strictly decreasing for $y \in (0, \hat{\psi}(L))\cup (\hat{\psi}(b_L^*),+\infty)$.
3. There exists some constant $\bar{d}_L \in (L,b_L^*)$ such that $(\mathcal{L} - \hat{r})\hat{h}_L(\bar{d}_L) = 0$, and $\hat{H}_L$ is
    - convex if $y\in (0, \hat{\psi}(L))\cup (\hat{\psi}(\bar{d}_L),\infty)$
    - concave if $y \in (\hat{\psi}(L), \hat{\psi}(\bar{d}_L))$

In addition, $\hat{z}_1 \in (\hat{\psi}(L), \hat{\psi}(\bar{d}_L))$, where $\hat{z}_1 := \argmax_{y\in [0,\infty)} \hat{H}_L(y)$.

<details>
<summary>Proof</summary>

**(1):** The continuity of  $\hat{H}_L(y)$ on $(0,\infty)$ is implied by the continuities of $\hat{h}_L$, $\hat{G}$ and $\hat{\psi}$. The continuity of $\hat{H}_L(y)$ at $0$ follows from

$$
\begin{align*}
  \hat{H}_L(0) =& \lim_{x\to -\infty}\frac{(\hat{h}_L(x))^+}{\hat{G}(x)} = \lim_{x\to -\infty}\frac{0}{\hat{G}(x)}=0 \\
  \lim_{y\to 0}\hat{H}_L(y) =& \lim_{x\to -\infty}\frac{\hat{h}_L}{\hat{G}}(x) = \lim_{x\to -\infty}\frac{-(c+\hat{c})}{\hat{G}(x)} = 0
\end{align*}
$$

where we have used that $y = \hat{\psi}(x) \rightarrow 0$ as $x \to -\infty$.

Furthermore, for $x \in (-\infty, L]\cup [b_L^*,\infty)$, we have $V_L(x) = x - c$, and thus, $\hat{h}_L(x)=-(c + \hat{c})$. Also, with the facts that $\hat{\psi}(x)$ is a strictly increasing function and $\hat{G}(x) > 0$, property **(1)** follows.

**(2):** By the definition of $\hat{H}_L$, since $\hat{G}$ and $\hat{\psi}$ are differentiable everywhere, we only need to show the differentiability of $V_L(x)$. To this end, $V_L(x)$ is differentiable at $b_L^*$ by $\eqref{equation-27}$-$\eqref{equation-26}$, but not at $L$. Therefore, $\hat{H}_L$ is differentiable for $y \in (0,\hat{\psi}(L)) \cup (\hat{\psi}(L), \infty)$.

In view of the facts that $\hat{G}'(x) < 0$, $\hat{\psi}'(x) > 0$, and $ \hat{G}^2(x) > 0$, we have for $x\in (-\infty, L)\cup [b_L^*,\infty)$

$$
\begin{align*}
  \hat{H}_L'(y) =& \frac{1}{\hat{\psi}'(x)} \left(\frac{\hat{h}_L}{\hat{G}}\right)'(x) = \frac{1}{\hat{\psi}'(x)} \left(\frac{-(c + \hat{c})}{\hat{G}(x)}\right)' \\
  =& \frac{(c + \hat{c})\hat{G}'(x)}{\hat{\psi}'(x)\hat{G}^2(x)} < 0.
\end{align*}
$$

Thus, $\hat{H}_L(y)$ is strictly decreasing for $y \in (0, \hat{\psi}(L))\cup [\hat{\psi}(b_L^*),+\infty)$.

**(3):** Both $\hat{G}$ and $\hat{\psi}$ are twice differentiable everywhere, while $V_L(x)$ is twice differentiable everywhere except at $x=L$ and $b^*$, and so is $\hat{h}_L(x)$. Thus, $\hat{H}_L(y)$ is twice differentiable on $(0,\hat{\psi}(L)) \cup (\hat{\psi}(L),\hat{\psi}(b^*)) \cup (\hat{\psi}(b^*), \infty)$.

To determine the convexity/concavity of $\hat{H}_L$, we look at the second order derivative:

$$
  \hat{H}_L''(y) = \frac{2}{\sigma^2\hat{G}(x)(\hat{\psi}'(x))^2}(\mathcal{L} - \hat{r})\hat{h}_L(x),
$$

whose sign is determined by

$$
\begin{align*}
  (\mathcal{L} - \hat{r})\hat{h}_L(x) =& \frac{1}{2} \sigma^2 V_L''(x) + \mu(\theta - x) V_L'(x) - \mu (\theta - x) - \hat{r}(V_L(x) - x -\hat{c}) \\
  =& \begin{cases}
    (r - \hat{r})V_L(x) + (\mu + \hat{r})x - \mu\theta + \hat{r}\hat{c},\quad& x \in (L, b_L^*) \\
    \hat{r}(c + \hat{c}) >0,\quad& x \in (-\infty, L) \cup (b_L^*,\infty).
  \end{cases}
\end{align*}
$$

This implies that $\hat{H}_L$ is convex for $y \in (0, \hat{\psi}(L))\cup (\hat{\psi}(b_L^*),\infty)$.

On the other hand, the condition $\sup_{x\in\R}\hat{h}_L(x) > 0$ implies that $\sup_{y\in [0,\infty)}\hat{H}_L(y) > 0$. By **(1)** and twice differentiability of $\hat{H}_L(y)$ for $y \in (\hat{\psi}(L),\hat{\psi}(b_L^*))$, there must exist an interval $(\hat{\psi}(\underline{a}_L), \hat{\psi}(\bar{d}_L)) \subseteq (\hat{\psi}(L),\hat{\psi}(b_L^*))$ such  that $\hat{H}_L(y)$ is concave, maximized at $\hat{z}_1 \in (\hat{\psi}(\underline{a}_L), \hat{\psi}(\bar{d}_L))$.

Furthermore, if  $V_L(x)$ is strictly increasing on $(L, b_L^*)$, then $(\mathcal{L} - \hat{r})\hat{h}_L(x)$ is also strictly increasing. To prove this, we first recall from Proposition $\ref{proposition-1}$ that $H(y)$ is strictly increasing and concave on $(\psi(L^*), +\infty)$. By Proposition $\ref{proposition-4}$, we have $b_L^* < b^*$, which implies $z_L < z$, and thus, $H'(z_L)>H'(z)$.

Then, it follows from $\eqref{equation-7}$, $\eqref{equation-8}$ and $\eqref{equation-29}$ that $W_L'(y)= H'(z_L) > H'(z) = W'(y)$ for $y\in (\psi(L), z_L)$. Next, since $W_L(y) = \frac{V_L}{G}\circ \psi^{-1}(y)$, we have

$$
\begin{align*}
  W_L'(y) &= \frac{1}{\psi'(x)} \left(\frac{V_L}{G}\right)'(x) \\
  =& \frac{1}{\psi'(x)} (\frac{V_L'(x)G(x) - V_L(x)G'(x)}{G^2(x)}).
\end{align*}
$$

The same holds for $W'(y)$ with $V(x)$ replacing $V_L(x)$. As both $\psi'(x)$ and $G^2(x)$ are positive, $W_L'(y)>  W'(y)$ is equivalent to $V_L'(x)G(x) - V_L(x)G'(x) > V'(x)G(x) - V(x)G'(x)$. This implies that

$$
  V_L'(x) - V'(x) = -\frac{G'(x)}{G(x)}(V(x) - V_L(x)) > 0
$$

since $G(x) > 0$, $G'(x) < 0$, and $V(x) > V_L(x)$. Recalling that $V'(x) > 0$, we have established that $V_L(x)$ is a strictly increasing function, and so is $(\mathcal{L} - \hat{r})\hat{h}_L(x)$. As we have shown the existence of an interval $(\hat{\psi}(\underline{a}_L), \hat{\psi}(\bar{d}_L)) \subseteq (\hat{\psi}(L),\hat{\psi}(b_L^*))$ over which $\hat{H}(y)$ is concave, or equivalently $(\mathcal{L} - \hat{r})\hat{h}_L(x) < 0$ with $x = \hat{\psi}^{-1}(y)$. Then by the strictly increasing property of $(\mathcal{L} - \hat{r})\hat{h}_L(x)$, we conclude $\underline{a}_L = L$ and $\bar{d}_L \in (L, b_L^*)$ is the unique solution to $(\mathcal{L} - \hat{r})\hat{h}_L(x)=0$, and

$$
\begin{align*}
  (\mathcal{L} - \hat{r})\hat{h}_L(x) \begin{cases}
    < 0,\quad& x \in (L, \bar{d}_L) \\
    > 0,\quad& x \in (-\infty, L)\cup (\bar{d}_L, b_L^*) \cup (b_L^*, \infty).
  \end{cases}
\end{align*}
$$

Hence, we conclude the convexity and concavity of the function $\hat{H}_L$.
</details>
</MathBox>

### Relative stop-loss

For some investors, it may be more desirable to set the stop-loss contingent on  the entry level. In other words, if the value of $X$ at the entry time  is $x$, then  the investor would assign a lower stop-loss level $x-\ell$, for some constant $\ell >0$. Therefore, the investor faces the optimal entry timing problem

$$
  \mathcal{J}_\ell(x)= \sup_{\nu\in\mathcal{T}}\mathbb{E}_x \left[e^{-\hat{r} \nu} (\mathcal{V}_\ell(X_{\nu}) - X_{\nu} - \hat{c})\right]
$$

where $\mathcal{V}_\ell(x) := V_{x - \ell}(x)$ is the optimal exit timing problem with stop-loss level $x-\ell$. The dependence of $V_{x-\ell}(x)$ on $x$ is  significantly more complicated than $V(x)$ or $V_L(x)$, making the problem much less tractable. The investor will still enter at a lower level $d^*$. After entry, the investor will wait to exit at either the stop-loss level $d^*-\ell$ or an upper level $b^*$.